<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Arena Design</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
    }
    
    h2 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
      color: #000000;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    label {
      font-size: 12px;
      font-weight: 500;
      color: #000000;
    }
    
    input, textarea {
      padding: 8px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-size: 12px;
      font-family: inherit;
      width: 100%;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #18a0fb;
    }
    
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    
    button {
      padding: 8px 16px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
    }
    
    button:hover {
      background: #1591e6;
    }
    
    button:disabled {
      background: #e5e5e5;
      color: #999999;
      cursor: not-allowed;
    }
    
    .status {
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      background: #f0f0f0;
      color: #333333;
    }
    
    .status.active {
      background: #e3f5ff;
      color: #0d66d0;
    }
    
    .status.error {
      background: #ffe3e3;
      color: #d00d0d;
    }
    
    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .info {
      font-size: 11px;
      color: #666666;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Arena Design</h2>
    
    <!-- Manual Design Creation Section -->
    <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border: 2px solid #18a0fb;">
      <h3 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #000;">Manual Design Creation</h3>
      
      <div class="input-group">
        <label for="fullHtmlInput">HTML/CSS Code</label>
        <textarea 
          id="fullHtmlInput" 
          placeholder="Paste full HTML (with <style> tags) or just HTML..."
          rows="8"
          style="font-family: monospace; font-size: 11px; resize: vertical; min-height: 160px;"
        ></textarea>
      </div>
      
      <div class="info" style="font-size: 10px; color: #666; margin-top: 4px;">
        ðŸ’¡ Tip: You can paste full HTML with &lt;style&gt; tags, or just HTML and CSS separately below
      </div>
      
      <!-- <details style="margin-top: 8px;">
        <summary style="cursor: pointer; font-size: 11px; color: #0066ff; font-weight: 500;">
          Or paste HTML and CSS separately â–¼
        </summary>
        <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">
          <div class="input-group">
            <label for="htmlInput">HTML Only</label>
            <textarea 
              id="htmlInput" 
              placeholder="Enter HTML code..."
              rows="3"
              style="font-family: monospace; font-size: 11px; resize: vertical; min-height: 60px;"
            ></textarea>
          </div>
          
          <div class="input-group">
            <label for="cssInput">CSS Only</label>
            <textarea 
              id="cssInput" 
              placeholder="Enter CSS code..."
              rows="3"
              style="font-family: monospace; font-size: 11px; resize: vertical; min-height: 60px;"
            ></textarea>
          </div>
        </div>
      </details> -->
      
      <button id="createBtn" style="width: 100%; margin-top: 12px;">Create Design Now</button>
      <div class="status" id="createStatus" style="margin-top: 8px; display: none;"></div>
    </div>
    
    <!-- Divider -->
    <div style="border-top: 1px solid #e5e5e5; margin: 8px 0;"></div>
    
    <!-- Automated Polling Section -->
    <!-- <div>
      <h3 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #000;">Automated Polling</h3>
      
      <div class="info" style="background: #e3f5ff; padding: 12px; border-radius: 6px;">
        <strong>Database Status:</strong><br>
        <span id="dbStats">Loading...</span>
      </div>
      
      <div class="input-group">
        <label for="pollInterval">Poll Interval (seconds)</label>
        <input 
          type="number" 
          id="pollInterval" 
          placeholder="60"
          value="60"
          min="5"
        />
      </div>
      
      <div class="toggle-container">
        <button id="toggleBtn">Start Polling</button>
        <div class="status" id="status">Inactive</div>
      </div>
      
      <div class="info">
        This plugin polls the internal database every interval and creates Figma designs for items with status "NEW". After creation, the status is automatically updated to "COMPLETED".
      </div>
      
      <div id="lastUpdate" class="info" style="display: none;">
        Last update: <span id="lastUpdateTime"></span>
      </div>
    </div> -->
  </div>

  <script>
    // Manual creation elements
    var fullHtmlInput = document.getElementById('fullHtmlInput');
    var htmlInput = document.getElementById('htmlInput');
    var cssInput = document.getElementById('cssInput');
    var createBtn = document.getElementById('createBtn');
    var createStatusEl = document.getElementById('createStatus');
    
    // Polling elements (may be null if section is commented out)
    var pollIntervalInput = document.getElementById('pollInterval');
    var toggleBtn = document.getElementById('toggleBtn');
    var statusEl = document.getElementById('status');
    var lastUpdateEl = document.getElementById('lastUpdate');
    var lastUpdateTimeEl = document.getElementById('lastUpdateTime');
    var dbStatsEl = document.getElementById('dbStats');
    
    var isPolling = false;
    
    // Load saved settings
    parent.postMessage({ pluginMessage: { type: 'load-settings' } }, '*');
    
    // Handle messages from plugin code
    onmessage = function(event) {
      var msg = event.data.pluginMessage;
      
      if (msg.type === 'settings-loaded') {
        if (pollIntervalInput && msg.pollInterval) pollIntervalInput.value = msg.pollInterval;
        if (msg.isPolling) {
          isPolling = true;
          updateUI();
        }
        if (dbStatsEl) updateDatabaseStats(msg.newCount, msg.completedCount, msg.totalCount);
      } else if (msg.type === 'polling-started') {
        isPolling = true;
        updateUI();
      } else if (msg.type === 'polling-stopped') {
        isPolling = false;
        updateUI();
      } else if (msg.type === 'update-status') {
        updateStatus(msg.status, msg.message);
        if (msg.status === 'success' && lastUpdateTimeEl && lastUpdateEl) {
          lastUpdateTimeEl.textContent = new Date().toLocaleTimeString();
          lastUpdateEl.style.display = 'block';
        }
      } else if (msg.type === 'database-updated') {
        // Reload stats when database is updated
        parent.postMessage({ pluginMessage: { type: 'load-settings' } }, '*');
      } else if (msg.type === 'design-created') {
        createStatusEl.textContent = 'Design created successfully!';
        createStatusEl.className = 'status active';
        createBtn.disabled = false;
        setTimeout(function() {
          createStatusEl.style.display = 'none';
          fullHtmlInput.value = '';
          htmlInput.value = '';
          cssInput.value = '';
        }, 3000);
      } else if (msg.type === 'design-error') {
        createStatusEl.textContent = 'Error: ' + (msg.error || 'Failed to create design');
        createStatusEl.className = 'status error';
        createBtn.disabled = false;
      } else if (msg.type === 'set-html-css') {
        // Allow external setting of HTML/CSS (for automation)
        // Supports both full HTML and separate HTML/CSS
        if (msg.fullHtml) {
          fullHtmlInput.value = msg.fullHtml;
        } else {
          if (msg.html) htmlInput.value = msg.html;
          if (msg.css) cssInput.value = msg.css;
        }
        if (msg.autoSubmit) {
          createBtn.click();
        }
      }
    };
    
    if (toggleBtn) {
      toggleBtn.onclick = function() {
        var pollInterval = parseInt(pollIntervalInput.value) || 60;
        
        if (pollInterval < 5) {
          alert('Poll interval must be at least 5 seconds');
          return;
        }
        
        if (!isPolling) {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'start-polling',
              pollInterval: pollInterval
            } 
          }, '*');
        } else {
          parent.postMessage({ 
            pluginMessage: { type: 'stop-polling' } 
          }, '*');
        }
      };
    }
    
    createBtn.onclick = function() {
      var html = '';
      var css = '';
      
      // Check if user used the full HTML/CSS input (primary method)
      var fullHtml = fullHtmlInput.value.trim();
      
      if (fullHtml) {
        // Extract CSS from <style> tags
        var styleMatch = fullHtml.match(/<style[^>]*>([\s\S]*?)<\/style>/);
        if (styleMatch) {
          css = styleMatch[1].trim();
          // Remove style tags from HTML
          fullHtml = fullHtml.replace(/<style[^>]*>[\s\S]*?<\/style>/g, '');
        }
        
        // Extract body content if present
        var bodyMatch = fullHtml.match(/<body[^>]*>([\s\S]*?)<\/body>/);
        if (bodyMatch) {
          html = bodyMatch[1].trim();
        } else {
          // Remove html, head, doctype tags if present
          html = fullHtml
            .replace(/<!DOCTYPE[^>]*>/gi, '')
            .replace(/<html[^>]*>/gi, '')
            .replace(/<\/html>/gi, '')
            .replace(/<head[^>]*>[\s\S]*?<\/head>/gi, '')
            .replace(/<body[^>]*>/gi, '')
            .replace(/<\/body>/gi, '')
            .trim();
        }
      } else {
        // Fall back to separate fields
        html = htmlInput.value.trim();
        css = cssInput.value.trim();
      }
      
      if (!html && !css) {
        alert('Please enter HTML/CSS code');
        return;
      }
      
      createStatusEl.style.display = 'block';
      createStatusEl.textContent = 'Creating design...';
      createStatusEl.className = 'status active';
      createBtn.disabled = true;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'create-design-now',
          html: html,
          css: css
        } 
      }, '*');
    };
    
    function updateUI() {
      if (!toggleBtn || !statusEl || !pollIntervalInput) return;
      
      if (isPolling) {
        toggleBtn.textContent = 'Stop Polling';
        statusEl.textContent = 'Active';
        statusEl.className = 'status active';
        pollIntervalInput.disabled = true;
      } else {
        toggleBtn.textContent = 'Start Polling';
        statusEl.textContent = 'Inactive';
        statusEl.className = 'status';
        pollIntervalInput.disabled = false;
      }
    }
    
    function updateStatus(status, message) {
      if (!statusEl) return;
      
      if (status === 'error') {
        statusEl.textContent = message || 'Error';
        statusEl.className = 'status error';
      } else if (status === 'success') {
        statusEl.textContent = message || 'Active';
        statusEl.className = 'status active';
        // Reload stats after successful processing
        parent.postMessage({ pluginMessage: { type: 'load-settings' } }, '*');
      } else if (status === 'polling') {
        statusEl.textContent = 'Checking for updates...';
        statusEl.className = 'status active';
      }
    }
    
    function updateDatabaseStats(newCount, completedCount, totalCount) {
      if (!dbStatsEl) return;
      
      dbStatsEl.innerHTML = 
        '<strong style="color: #28a745;">' + newCount + '</strong> NEW | ' +
        '<strong style="color: #6c757d;">' + completedCount + '</strong> COMPLETED | ' +
        '<strong>' + totalCount + '</strong> Total';
    }
  </script>
</body>
</html>

